name: 'Generate changelog and create release'
description: 'Generate a changelog and create a GitHub release'

inputs:
  artifactory_password:
    description: 'Secret Artifactory_password password'
    required: true

  artifactory_username:
    description: 'Secret Artifactory_password username'
    required: true

outputs:
  changelog:
    description: 'The generated changelog with optional jira links'
    value: ${{ steps.changelog-with-jira-links.outputs.text }}

  changelog-skipped:
    description: 'Boolean specifying if changelog step has been skipped'
    value: ${{ steps.conventional-changelog.outputs.skipped }}

  version:
    description: 'The new version'
    value: ${{ steps.conventional-changelog.outputs.version }}

runs:
  using: 'composite'
  steps:
    - name: "Copy Maven settings"
      # Use always master as ref
      uses: CleverShuttle/gh-composite-actions/actions/maven-settings@master

    - name: 'Generate changelog'
      id: conventional-changelog
      # https://github.com/TriPSs/conventional-changelog-action
      uses: TriPSs/conventional-changelog-action@v3.11.0
      with:
        github-token: ${{ github.token }}
        git-push: false
        skip-version-file: true
        skip-commit: true

    - name: 'Generate Jira links for the changelog'
      shell: bash
      id: changelog-with-jira-links
      env:
        CHANGELOG: ${{ steps.conventional-changelog.outputs.clean_changelog }}
      run: |
        if [ -z "${{ env.CHANGELOG }}" ]; then
          output=""
          echo "::set-output name=text::$output"
        else
          output=$(node ${{ github.action_path }}/generate-jira-links.js)
          output="${output//'%'/'%25'}"
          output="${output//$'\n'/'%0A'}"
          output="${output//$'\r'/'%0D'}"
          echo "::set-output name=text::$output"
        fi

    - name: 'Bump project maven versions'
      shell: bash
      env:
        USERNAME: ${{ inputs.artifactory_username }}
        PASSWORD: ${{ inputs.artifactory_password }}
      run: |
        mvn versions:set \
          -DnewVersion=${{ steps.conventional-changelog.outputs.version }} \
          -N versions:update-child-modules \
          -DgenerateBackupPoms=false
        mvn versions:commit

    - name: 'Commit changes'
      shell: bash
      run: |
        git add .
        git commit -m "chore(release): ${{ steps.conventional-changelog.outputs.version }}" -a

    - name: 'Push changes'
      # https://github.com/ad-m/github-push-action
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ github.token }}
        branch: ${{ github.ref }}

    - name: 'Create Github release'
      # https://github.com/softprops/action-gh-release
      id: gh-release
      uses: softprops/action-gh-release@v0.1.14
      env:
        github_token: ${{ github.token }}
      with:
        body: ${{ steps.changelog-with-jira-links.outputs.text }}
        tag_name: ${{ steps.conventional-changelog.outputs.tag }}
        name: ${{ steps.conventional-changelog.outputs.tag }}

    - name: 'Outputs'
      shell: bash
      run: |
        echo "Changelog: '${{ steps.changelog-with-jira-links.outputs.text }}'"
        echo "Version: '${{ steps.conventional-changelog.outputs.version }}'"
        echo "Skipped: '${{ steps.conventional-changelog.outputs.skipped }}'"
